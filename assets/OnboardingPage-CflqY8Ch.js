import{r as b,u as Z,a as ee,j as e,m as O,M as L}from"./index-CVOoTMyE.js";import{u as te}from"./useVoice-Bs4LMxgn.js";import{A as ae}from"./arrow-left-DbSgRtZB.js";import{A as ne}from"./arrow-right-FTiqWHJY.js";import{U as H}from"./upload-C5FUqA4Q.js";const I="/api/onboarding",j={checkCitizen:async o=>{const i=await fetch(`${I}/citizen/mobile/${o}`);if(i.status===404)return null;if(!i.ok)throw new Error("Network error checking user");return i.json()},createCitizen:async o=>{const i=await fetch(`${I}/citizen`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok){const d=await i.json();throw new Error(d.error||"Failed to create citizen")}return i.json()},createProfile:async(o,i)=>{const d=await fetch(`${I}/citizen/${o}/profile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!d.ok){const u=await d.json();throw new Error(u.error||"Failed to create profile")}return d.json()},sendOTP:async o=>{const i=await fetch("/api/identity/send-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:o})});if(!i.ok){const d=await i.json().catch(()=>({}));throw new Error(d.message||`Failed to send OTP: ${i.status}`)}return i.json()},verifyOTP:async(o,i,d)=>{const u=await fetch("/api/identity/verify-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:o,otp:i,vid:d})});if(!u.ok){const s=await u.json();throw new Error(s.message||"OTP Verification Failed")}return u.json()},updateProfile:async(o,i)=>{const d=await fetch(`/api/users/${o}/profile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!d.ok)throw new Error("Failed to update profile");return d.json()},getProfile:async o=>{const i=await fetch(`/api/users/${o}`);if(!i.ok)throw new Error("Failed to fetch profile");return i.json()}},se=()=>{const{listen:o,isListening:i,cancel:d}=te(),[u,s]=b.useState(null),[v,N]=b.useState(0);return{fillField:b.useCallback((g,k,C,h)=>{s(g),o(async(p,S)=>{const w=p.replace(/\.$/,"").trim();if(N(S),S<.6&&console.warn("Low confidence voice input"),k(w),C&&w.length>5)try{const m=await(await fetch("/api/chat/extract-entities",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:w,context:h||{}})})).json();m&&Object.keys(m).length>0&&(console.log("Smart Fill Data:",m),C(m))}catch(y){console.error("Smart Fill Failed",y)}s(null)})},[o]),isListening:i,activeField:u,stopListening:d}},de=()=>{const o=Z(),{language:i,setLanguage:d,setHighContrast:u,t:s}=ee(),[v,N]=b.useState("mobile"),[l,g]=b.useState(0),[k,C]=b.useState(""),[h,p]=b.useState(!1),[S,w]=b.useState(null),{fillField:y,activeField:m}=se(),[x,T]=b.useState(localStorage.getItem("citizenId")),[n,c]=b.useState({mobile_number:"",full_name:"",age:"",district:"Chennai",state:"Tamil Nadu",details:"",pincode:"",income_band:"BPL",disabilities:[],documents:{},prefers_voice:!1,high_contrast:!1});b.useEffect(()=>{(async()=>{if(x)try{const a=await j.getProfile(x);a&&(c(r=>{var f,z,F,E,A,U,$,D,J,M,V,G,B,W;return{...r,full_name:((f=a.profile)==null?void 0:f.fullName)||"",age:((F=(z=a.profile)==null?void 0:z.age)==null?void 0:F.toString())||"",district:((E=a.profile)==null?void 0:E.district)||"Chennai",details:((U=(A=a.profile)==null?void 0:A.address)==null?void 0:U.street)||"",pincode:((D=($=a.profile)==null?void 0:$.address)==null?void 0:D.postalCode)||"",income_band:((M=(J=a.profile)==null?void 0:J.income)==null?void 0:M.category)||"BPL",disabilities:((G=(V=a.profile)==null?void 0:V.disabilities)==null?void 0:G.map(Y=>Y.type))||[],high_contrast:((W=(B=a.preferences)==null?void 0:B.accessibilitySettings)==null?void 0:W.highContrast)||!1}}),a.currentStep&&(g(a.currentStep),N("wizard")))}catch(a){console.error("Failed to load profile",a)}})()},[x]);const[_,P]=b.useState(()=>{const t=localStorage.getItem("onboarding_offline_queue");return t?JSON.parse(t):[]});b.useEffect(()=>{const t=async()=>{if(navigator.onLine&&_.length>0&&x){console.log("Syncing offline onboarding data...");const r=_[0];try{await j.updateProfile(x,r),P(f=>f.slice(1))}catch{console.error("Sync failed, will retry later")}}},a=()=>t();return window.addEventListener("online",a),navigator.onLine&&t(),()=>window.removeEventListener("online",a)},[_,x]),b.useEffect(()=>{localStorage.setItem("onboarding_offline_queue",JSON.stringify(_))},[_]);const q=async t=>{if(!x)return;const a={...t,currentStep:l+1};if(!navigator.onLine){console.warn("Offline: Queuing update"),P(r=>[...r,a]);return}try{console.log("Saving progress...",t),await j.updateProfile(x,a)}catch(r){console.error("Auto-save failed, queuing",r),P(f=>[...f,a])}},Q=async t=>{t.preventDefault(),p(!0);try{await j.sendOTP(n.mobile_number),N("otp"),window.speechSynthesis.speak(new SpeechSynthesisUtterance("OTP sent."))}catch(a){w(a.message)}finally{p(!1)}},R=async t=>{t.preventDefault(),p(!0);try{const a=await j.verifyOTP(n.mobile_number,k);if(a.success){if(a.citizenId)T(a.citizenId);else{const r=await j.createCitizen({mobile_number:n.mobile_number,full_name:"Draft User",aadhaar_ref_key:a.token,gender:"Other",address:{state:"TN",district:"CH",pincode:"000",rural_urban_flag:"Urban"}});T(r.citizen_id)}N("wizard"),g(0),window.speechSynthesis.speak(new SpeechSynthesisUtterance("Verified. Let's setup your profile."))}}catch(a){w(a.message)}finally{p(!1)}},K=async()=>{p(!0);let t={};l===0&&(t={profile:{fullName:n.full_name}}),l===1&&(t={profile:{age:parseInt(n.age)}}),l===2&&(t={profile:{district:n.district}}),l===3&&(t={disability_details:n.disabilities.map((a,r)=>({type:a,categoryId:r,severity:40}))}),l===4&&(t={profile:{income:{category:n.income_band}}}),l===5&&(t={profile:{address:{street:n.details,postalCode:n.pincode}}}),l===6&&(t={}),l===7&&(t={preferences:{accessibilitySettings:{highContrast:n.high_contrast}}}),await q(t),l<7?g(a=>a+1):o("/dashboard"),p(!1)},X=()=>{switch(l){case 0:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step1")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text","aria-label":s("onboarding.step1"),value:n.full_name,onChange:t=>c({...n,full_name:t.target.value}),className:"w-full p-4 rounded-xl bg-white/5 border border-white/20 text-2xl",placeholder:"e.g. Rahul Kumar",autoFocus:!0}),e.jsx("button",{"aria-label":"Use Voice Input for Name",onClick:()=>y("full_name",t=>c(a=>({...a,full_name:t})),t=>{t.full_name&&c(a=>({...a,full_name:t.full_name}))},{full_name:"string"}),className:"absolute right-4 top-1/2 -translate-y-1/2 p-2",children:e.jsx(L,{className:m==="full_name"?"animate-pulse text-red-500":"text-gray-400"})})]})]});case 1:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step2")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number","aria-label":s("onboarding.step2"),value:n.age,onChange:t=>c({...n,age:t.target.value}),className:"w-full p-4 rounded-xl bg-white/5 border border-white/20 text-2xl",placeholder:"e.g. 35"}),e.jsx("button",{"aria-label":"Use Voice Input for Age",onClick:()=>y("age",t=>c(a=>({...a,age:t})),t=>{t.age&&c(a=>({...a,age:t.age.toString()}))},{age:"number"}),className:"absolute right-4 top-1/2 -translate-y-1/2 p-2",children:e.jsx(L,{className:m==="age"?"animate-pulse text-red-500":"text-gray-400"})})]})]});case 2:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step3")}),e.jsxs("select",{value:n.district,onChange:t=>c({...n,district:t.target.value}),className:"w-full p-4 rounded-xl bg-gray-800 border border-white/20 text-xl",children:[e.jsx("option",{children:"Chennai"}),e.jsx("option",{children:"Coimbatore"}),e.jsx("option",{children:"Madurai"}),e.jsx("option",{children:"Salem"})]})]});case 3:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step4")}),e.jsx("div",{className:"grid grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-2",children:["Blindness","Low Vision","Hearing Impairment","Locomotor Disability","Mental Illness","Autism"].map(t=>e.jsx("button",{onClick:()=>{const a=n.disabilities;c({...n,disabilities:a.includes(t)?a.filter(r=>r!==t):[...a,t]})},className:`p-4 rounded-xl border text-left font-bold transition-all ${n.disabilities.includes(t)?"bg-blue-600 border-blue-500 text-white":"bg-white/5 border-white/10 hover:bg-white/10"}`,children:t},t))})]});case 4:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step5")}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:n.income_band,onChange:t=>c({...n,income_band:t.target.value}),className:"w-full p-4 rounded-xl bg-gray-800 border border-white/20 text-xl appearance-none",children:[e.jsx("option",{value:"BPL",children:"No Income / BPL"}),e.jsx("option",{value:"EWS",children:"Under ₹2.5 Lakhs"}),e.jsx("option",{value:"LIG",children:"₹2.5L - ₹5 Lakhs"}),e.jsx("option",{value:"MIG",children:"Above ₹5 Lakhs"})]}),e.jsx("button",{onClick:()=>y("income",t=>{},t=>{if(t.income_band)c(a=>({...a,income_band:t.income_band}));else if(t.income){const a=parseInt(t.income);a<25e4?c(r=>({...r,income_band:"EWS"})):a<5e5?c(r=>({...r,income_band:"LIG"})):c(r=>({...r,income_band:"MIG"}))}},{income:"number",income_band:"string (EWS, LIG, MIG)"}),className:"absolute right-12 top-1/2 -translate-y-1/2 p-2 bg-gray-900 rounded-full",children:e.jsx(L,{className:m==="income"?"animate-pulse text-red-500":"text-gray-400"})})]})]});case 5:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step6")}),e.jsx("textarea",{value:n.details,onChange:t=>c({...n,details:t.target.value}),className:"w-full p-4 rounded-xl bg-white/5 border border-white/20 text-xl min-h-[120px]",placeholder:"Street Name, Area, Door No..."}),e.jsx("input",{type:"text",value:n.pincode,onChange:t=>c({...n,pincode:t.target.value}),className:"w-full p-4 rounded-xl bg-white/5 border border-white/20 text-xl",placeholder:"Pincode (e.g. 600028)"})]});case 6:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step7")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border border-dashed border-white/20 rounded-xl p-6 text-center hover:bg-white/5 cursor-pointer transition-colors",children:[e.jsx(H,{className:"mx-auto mb-2 text-blue-400"}),e.jsx("p",{className:"font-bold",children:"Upload Aadhaar / ID"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Supports JPG, PDF"})]}),e.jsxs("div",{className:"border border-dashed border-white/20 rounded-xl p-6 text-center hover:bg-white/5 cursor-pointer transition-colors",children:[e.jsx(H,{className:"mx-auto mb-2 text-green-400"}),e.jsx("p",{className:"font-bold",children:"Upload Disability Certificate"})]})]})]});case 7:return e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xl font-bold block",children:s("onboarding.step8")}),e.jsxs("button",{onClick:()=>{u(!n.high_contrast),c(t=>({...t,high_contrast:!t.high_contrast}))},className:`w-full p-6 rounded-xl border-2 flex items-center justify-between ${n.high_contrast?"bg-yellow-400 border-yellow-400 text-black":"bg-white/5 border-white/10"}`,children:[e.jsx("span",{className:"font-bold text-xl",children:"High Contrast Mode"}),e.jsx("div",{className:`w-6 h-6 rounded-full border-2 ${n.high_contrast?"bg-black border-black":"border-white/50"}`})]})]});default:return e.jsxs("div",{children:["Step ",l+1," Content TODO"]})}};return e.jsxs("div",{className:"min-h-screen bg-black text-white p-6 flex flex-col items-center justify-center",children:[v==="wizard"&&e.jsxs("div",{className:"w-full max-w-lg mb-8",children:[e.jsx("div",{className:"h-2 bg-gray-800 rounded-full overflow-hidden",children:e.jsx(O.div,{className:"h-full bg-blue-500",initial:{width:0},animate:{width:`${(l+1)/8*100}%`}})}),e.jsxs("p",{className:"text-right text-sm text-gray-400 mt-2",children:["Step ",l+1," of 8"]})]}),e.jsxs("div",{className:"w-full max-w-lg",children:[S&&e.jsx("div",{className:"bg-red-500/20 text-red-300 p-4 rounded-xl mb-6 border border-red-500/50",children:S}),v==="mobile"&&e.jsxs(O.form,{initial:{opacity:0},animate:{opacity:1},onSubmit:Q,className:"bg-gray-900/50 p-8 rounded-3xl border border-white/10 space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-center mb-8",children:s("onboarding.welcome")}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-400 mb-2",children:s("onboarding.mobileLabel")}),e.jsx("input",{type:"tel",value:n.mobile_number,onChange:t=>c({...n,mobile_number:t.target.value}),className:"w-full p-4 rounded-xl bg-black border border-white/20 text-2xl font-mono tracking-widest",placeholder:"9999999999",maxLength:10})]}),e.jsx("button",{disabled:h,className:"w-full bg-blue-600 py-4 rounded-xl font-bold text-xl hover:bg-blue-500",children:s(h?"common.loading":"common.next")})]}),v==="otp"&&e.jsxs(O.form,{initial:{x:50,opacity:0},animate:{x:0,opacity:1},onSubmit:R,className:"bg-gray-900/50 p-8 rounded-3xl border border-white/10 space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-center",children:s("onboarding.otpLabel")}),e.jsx("input",{type:"text",value:k,onChange:t=>C(t.target.value),className:"w-full p-4 rounded-xl bg-black border border-white/20 text-3xl font-mono text-center tracking-[1em]",maxLength:6,autoFocus:!0}),e.jsx("p",{className:"text-center text-sm text-gray-400",children:s("onboarding.otpHint")}),e.jsx("button",{disabled:h,className:"w-full bg-green-600 py-4 rounded-xl font-bold text-xl hover:bg-green-500",children:s(h?"common.loading":"common.next")})]}),v==="wizard"&&e.jsxs(O.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},className:"bg-gray-900/50 p-8 rounded-3xl border border-white/10 space-y-8 min-h-[400px] flex flex-col",children:[e.jsx("div",{className:"flex-1",children:X()}),e.jsxs("div",{className:"flex gap-4 pt-4 border-t border-white/10",children:[l>0&&e.jsx("button",{onClick:()=>g(t=>t-1),className:"px-6 py-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10",children:e.jsx(ae,{})}),e.jsxs("button",{onClick:K,disabled:h,className:"flex-1 bg-blue-600 py-4 rounded-xl font-bold text-xl hover:bg-blue-500 flex items-center justify-center gap-2",children:[s(h?"common.save":l===7?"onboarding.finish":"common.next"),e.jsx(ne,{})]})]})]},l)]})]})};export{de as OnboardingPage};
